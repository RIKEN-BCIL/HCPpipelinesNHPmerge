@startuml MNI nonlinear registration/copying
group MNI atlas registration
group Register template to MNI atlas
#palegreen:T1w_acpc_dc_restore,
T1w_acpc_dc_restore_brain,
(optional)T2w_acpc_dc_restore
(optional)T2w_acpc_dc_restore_brain;
note 
    All inputs are from 
    $T1w_dir_template
end note
:AtlasRegistrationToMNI152_FLIRTandFNIRT.sh;

    #orange:xfms/acpc_dc2standard, xfms/standard2acpc_dc.nii.gz
    T1w, T1w_restore, T1w_restore_brain,
    (optional)T2w, T2w_restore, T2w_restore_brain;
    note
        All outputs go to
        AtlasSpaceFolder_template=
        $StudyFolder
        /$Template
        /MNINonLinear
    end note
end group
group Apply warp to timepoint images
    split
    -[hidden]->
        :COPY AtlasSpaceFolder_template/xfms/*
        ${AtlasSpaceFolder_timepoint}/xfms/;
    split again
        -[hidden]->
        #palegreen:T1w_acpc_dc, 
        T1w_acpc_dc_restore,
        T1w_acpc_dc_restore_brain,
        (optional)T1w_acpc_dc,
        T1w_acpc_dc_restore,
        T1w_acpc_dc_restore_brain;
        note right
            All inputs are
            from $T1w_dir_long
        end note
    end split
    group Finalize timepoint images 
    :applywarp -w xfms/acpc_dc2standard.nii.gz ...;    
    #orange:T1w, T1w_restore,T1w_restore_brain,
    (optional)T2w, T2w_restore,T2w_restore_brain;
    
    :fslmaths T1w_restore -mas T1w_restore_brain T1w_restore_brain
    (optional) fslmaths T2w_restore -mas T1w_restore_brain T2w_restore_brain;
    note left
    Do we really need this?
    end note
    #orange:T1w_restore_brain, (optional)T2w_restore_brain;    
    floating note
        All processing is done in 
        $StudyFolder
        /$Timepoint_long/MNINonLinear
    end note
    end group
    detach
end group
end group
@enduml